<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>üéµ Music Search + Play</title>
  <style>
    /* ... (keep your existing CSS unchanged) ... */
    .fav-btn, .playlist-btn {
      background: none;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      margin-top: 8px;
      font-size: 14px;
      transition: color 0.2s;
    }
    .fav-btn.active {
      color: var(--brand);
    }
    .fav-btn:hover, .playlist-btn:hover {
      color: var(--text);
    }
  </style>
</head>
<body>
  <div class="sidebar">
    <div class="logo">Musicify</div>
    <a href="#" class="nav-item" onclick="showHome()">üè† Home</a>
    <a href="#" class="nav-item" onclick="showFavorites()">‚ù§Ô∏è Favorites</a>
    <a href="#" class="nav-item" onclick="showHistory()">‚è±Ô∏è History</a>
    <a href="#" class="nav-item" onclick="showPlaylists()">üé∂ Playlists</a>
  </div>

  <div class="main">
    <div class="searchbar">
      <input type="text" class="search-input" placeholder="What do you want to listen to?" id="query" autocomplete="off">
    </div>
    
    <div id="status" class="status"></div>
    
    <h2 class="section-title" id="section-title">Search Results</h2>
    <div id="results" class="results-grid"></div>
  </div>

  <!-- ... (keep your existing player markup unchanged) ... -->

  <iframe id="yt-frame" style="display:none;"></iframe>

  <script>
    const YOUTUBE_API_KEY = "YOUR_KEY_HERE";

    // --- NEW: Storage ---
    const STORAGE_KEY = "musicifyData";
    let musicifyData = JSON.parse(localStorage.getItem(STORAGE_KEY)) || {
      history: [],
      favorites: [],
      playlists: {}
    };

    function saveData() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(musicifyData));
    }

    // --- Existing variables (keep your old ones) ---
    const queryInput = document.getElementById('query');
    const statusBox = document.getElementById('status');
    const resultsEl = document.getElementById('results');
    const sectionTitle = document.getElementById('section-title');

    // ... (keep rest of your player variables)

    // --- NEW: Render Results with Fav & Playlist buttons ---
    function renderResults(items) {
      resultsEl.innerHTML = '';
      items.forEach((rec, index) => {
        const card = document.createElement('div');
        card.className = 'card';

        const img = document.createElement('img');
        img.className = 'card-img';
        const releaseId = rec.releases?.[0]?.id;
        img.src = releaseId ? `https://coverartarchive.org/release/${releaseId}/front-250` : placeholder();

        const title = document.createElement('div');
        title.className = 'card-title';
        title.textContent = rec.title || 'Untitled';

        const subtitle = document.createElement('div');
        subtitle.className = 'card-subtitle';
        const artists = rec['artist-credit']?.map(a => a.name).join(', ') || 'Unknown artist';
        subtitle.textContent = artists;

        const playBtn = document.createElement('div');
        playBtn.className = 'card-play';
        playBtn.innerHTML = '<svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor"><path d="M4.018 14L14.41 8 4.018 2z"></path></svg>';
        playBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          playTrack(index, items);
        });

        // --- NEW: Favorites Button ---
        const favBtn = document.createElement('button');
        favBtn.className = 'fav-btn';
        favBtn.textContent = '‚ù§Ô∏è';
        if (musicifyData.favorites.find(t => t.id === rec.id)) favBtn.classList.add('active');
        favBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          toggleFavorite(rec);
          favBtn.classList.toggle('active');
        });

        // --- NEW: Playlist Button ---
        const plBtn = document.createElement('button');
        plBtn.className = 'playlist-btn';
        plBtn.textContent = '‚ûï Playlist';
        plBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          addToPlaylist(rec);
        });

        card.appendChild(img);
        card.appendChild(title);
        card.appendChild(subtitle);
        card.appendChild(playBtn);
        card.appendChild(favBtn);
        card.appendChild(plBtn);
        card.addEventListener('click', () => playTrack(index, items));

        resultsEl.appendChild(card);
      });
    }

    // --- NEW: Toggle Favorite ---
    function toggleFavorite(rec) {
      const exists = musicifyData.favorites.find(t => t.id === rec.id);
      if (exists) {
        musicifyData.favorites = musicifyData.favorites.filter(t => t.id !== rec.id);
      } else {
        musicifyData.favorites.push({
          id: rec.id,
          title: rec.title,
          artist: rec['artist-credit']?.map(a => a.name).join(', '),
          releases: rec.releases
        });
      }
      saveData();
    }

    // --- NEW: Playlists ---
    function addToPlaylist(rec) {
      const name = prompt("Enter playlist name:");
      if (!name) return;
      if (!musicifyData.playlists[name]) musicifyData.playlists[name] = [];
      musicifyData.playlists[name].push(rec);
      saveData();
    }

    // --- NEW: Views ---
    function showHome() {
      sectionTitle.textContent = "Search Results";
      resultsEl.innerHTML = "<p>Type something in the search bar.</p>";
    }

    function showFavorites() {
      sectionTitle.textContent = "‚ù§Ô∏è Favorites";
      renderResults(musicifyData.favorites);
    }

    function showHistory() {
      sectionTitle.textContent = "‚è±Ô∏è History";
      renderResults(musicifyData.history);
    }

    function showPlaylists() {
      sectionTitle.textContent = "üé∂ Playlists";
      resultsEl.innerHTML = '';
      for (let [name, tracks] of Object.entries(musicifyData.playlists)) {
        const h3 = document.createElement('h3');
        h3.textContent = name;
        resultsEl.appendChild(h3);
        renderResults(tracks);
      }
    }

    // --- Modified PlayTrack to save history ---
    async function playTrack(index, list = searchResults) {
      const rec = list[index];
      if (!rec) return;
      const artists = rec['artist-credit']?.map(a => a.name).join(', ') || 'Unknown';
      const imgUrl = rec.releases?.[0]?.id ? `https://coverartarchive.org/release/${rec.releases[0].id}/front-250` : placeholder();

      // save to history (no duplicates)
      musicifyData.history = musicifyData.history.filter(t => t.id !== rec.id);
      musicifyData.history.unshift({ id: rec.id, title: rec.title, artist: artists, releases: rec.releases });
      if (musicifyData.history.length > 50) musicifyData.history.pop();
      saveData();

      // then continue your existing play logic...
      // (your old playTrack body remains here)
    }

    // ... (rest of your existing JS code unchanged)

  </script>
</body>
</html>
